
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TS水準測量（器高式）計算 – MVP</title>
<link rel="manifest" href="./manifest.webmanifest">
<style>
  :root{--bg:#ffffff;--card:#fafafa;--ink:#111827;--muted:#6b7280;--accent:#2563eb;--ok:#059669;--warn:#d97706;--border:#e5e7eb;--sticky-left:0px}
  *{box-sizing:border-box}
  body{margin:0;background:#ffffff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:clamp(1.2rem,2.5vw,1.6rem);font-weight:800;letter-spacing:0.02em}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:18px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .col{flex:1 1 240px}
  label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
  input[type="number"], input[type="text"], select{width:100%;background:#ffffff;border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:10px;outline:none}
  input[type="checkbox"]{transform:scale(1.15);margin-right:8px}
  .btn{appearance:none;border:1px solid #c7d2fe;background:#e0e7ff;color:#111827;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:.9rem}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  .btn.ghost{background:transparent;border-color:#c7d2fe}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:10px 10px}
  thead th{font-size:.9rem;color:var(--muted);background:#ffffff;position:sticky;top:0;z-index:2}
  tbody tr{background:#ffffff;border:1px solid var(--border)}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .tag{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;color:#2563eb;padding:4px 8px;border-radius:999px;font-size:.8rem}
  .footer{font-size:.85rem;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .grid > *{grid-column:span 12}
  @media (min-width:900px){.grid .span6{grid-column:span 6}}
  .pulse{animation:pulseBg 1.5s ease-out 1}
  @keyframes pulseBg{0%{background:#eef2ff}30%{background:#dbeafe}100%{background:#ffffff}}
  .table-wrap{overflow:auto}
  .sticky-name{position:sticky;left:var(--sticky-left);z-index:1;background:#ffffff}
  .sep{height:8px}
  .tests{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.88rem;white-space:pre-wrap;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>TS水準測量（器高式）計算 – スマホWebアプリ</h1>
  <div class="card">
    <div class="row">
      <div class="col">
        <label>ベンチマーク標高（BM GH, m）</label>
        <input id="bmGH" type="number" step="0.001" value="100.000" />
      </div>
      <div class="col">
        <label>ターゲット高（一定の場合, m）<span class="tag">任意</span></label>
        <input id="tgtH" type="number" step="0.001" placeholder="例: 1.500" />
      </div>
    </div>
    <div class="row"><label><input id="autoInvert" type="checkbox" checked />TSの高低差の符号を自動で器高式用（＋↔−）に反転</label></div>
    <div class="row"><label><input id="useTarget" type="checkbox" />ターゲット高補正を使う（各ΔHから h を減算→その後に符号反転）</label></div>
    <div class="row" style="gap:8px">
      <button class="btn primary" id="addRow">行を追加</button>
      <button class="btn ghost" id="example">例を入れる</button>
      <button class="btn ghost" id="clear">クリア</button>
      <span class="sep"></span>
      <button class="btn" id="calc">計算する</button>
      <button class="btn" id="exportCsv">CSV出力</button>
      <button class="btn" id="share">共有リンク</button>
      <span class="sep"></span>
      <button class="btn" id="runTests">テスト実行</button>
    </div>
  </div>

  <div class="card">
    <div class="tag">入力：TS表示の高低差（1行目=B.S@BM、以降=F.S@測点。途中B.S可=ターン/TP）</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>種別</th>
            <th>高低差 ΔH（TS表示, m）</th>
            <th class="sticky-name">測点名/メモ</th>
            <th>削除</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="grid">
    <div class="card span6">
      <h3>結果（器高式）</h3>
      <div class="row">
        <div class="col">
          <label>器械高 I.H (m)</label>
          <input id="ihOut" type="text" readonly />
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>入力行</th><th class="sticky-name">測点名</th><th>計算GH (m)</th></tr>
          </thead>
          <tbody id="outBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card span6">
      <h3>メモ</h3>
      <p class="footer">
        ・最初の行はB.S（BMに対する測定）。以降はF.S（求めたい測点）。<br>
        ・途中でB.Sを挿入した場合（折返し／T.P）は、直前のF.Sで求めたGHを新BMとみなし、I.Hを再計算して続行します。<br>
        ・「ターゲット高を一定」にすると理論上 h は相殺（TS間接水準）。<br>
        ・単位はメートル（m）。小数3桁。
      </p>
      <details>
        <summary>簡易テストの結果ログ</summary>
        <div id="testLog" class="tests">（まだテスト未実行）</div>
      </details>
    </div>
  </div>

  <p class="footer">© 2025 TS Leveling</p>
</div>

<script src="./app.js"></script>
<script>
  // PWA: Service Worker register (same folder scope)
  if ('serviceWorker' in navigator) {
    try { navigator.serviceWorker.register('./service-worker.js'); } catch(e) { console.warn(e); }
  }
</script>
</body>
</html>
