
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>後方交会・自由設置 計算アプリ (最終構成)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b6cff">
  <style>
    :root { --bg:#0b0f19; --card:#121826; --ink:#e6edf3; --muted:#93a1b2; --brand:#0b6cff; --line:#2b3b52; }
    html,body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Yu Gothic", "Meiryo", sans-serif; background:var(--bg); color:var(--ink); }
    header { position:sticky; top:0; z-index:10; background: linear-gradient(180deg, #0b0f19 0%, rgba(11,15,25,0.7) 100%); border-bottom:1px solid #1f2937; }
    header .wrap { display:flex; align-items:center; gap:.6rem; padding:.9rem 1rem; }
    h1 { font-size:1.05rem; margin:0; }
    main { padding: 1rem; display:grid; gap:1rem; max-width: 1060px; margin: 0 auto; }
    .card { background: var(--card); border:1px solid #1f2937; border-radius: 12px; padding: 1rem; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:.6rem; }
    label { font-size:.85rem; color:var(--muted); display:block; margin-bottom: .25rem; }
    input[type="number"], input[type="text"], select {
      width:100%; box-sizing:border-box; padding:.65rem .7rem; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:var(--ink);
      font-size: 1rem; font-variant-numeric: tabular-nums; letter-spacing: .02em;
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    input::placeholder { color:#64748b; }
    .btn { appearance:none; border:none; background:var(--brand); color:white; padding:.7rem 1rem; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.secondary { background:#253247; }
    .btn.ghost { background:transparent; border:1px solid #334155; }
    .btnbar { display:flex; gap:.6rem; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .grid { display:grid; gap:.7rem; }
    .hr { height:1px; background:#1f2937; margin:.8rem 0; }
    table { width:100%; border-collapse: collapse; font-size:.95rem; }
    th, td { padding:.45rem .5rem; border-bottom:1px solid var(--line); text-align:right; }
    th:first-child, td:first-child { text-align:left; }
    .pill { display:inline-block; padding:.18rem .5rem; border-radius:999px; border:1px solid #334155; color:#cbd5e1; font-size:.75rem; }
    .two-col { display:grid; grid-template-columns: 1fr; gap:1rem; }
    @media(min-width:1060px){ .two-col { grid-template-columns: 1.25fr .95fr; } }
    footer { color:#94a3b8; text-align:center; padding:1.2rem 1rem; font-size:.85rem; }

    /* angle block under coordinates (3点用) */
    .angleBlock { background:#0f172a; border:1px dashed #2b3b52; border-radius:10px; padding:.55rem; }
    .angleRow { display:grid; grid-template-columns: 1fr 24px 1fr 24px 1fr 24px; gap:.3rem; align-items:center; }
    .unit { color:#7aa2d6; text-align:center; }
    .angleTitle { color:#cfe1ff; font-size:.85rem; margin-bottom:.25rem; }

    /* bottom diagram (3点のみ表示) */
    .diagram { display:flex; justify-content:center; }
    .diagram svg { width: 220px; height: 160px; }
    .diagram text { font-size:13px; fill:#cfe1ff; }
    .diagram .arcLbl { fill:#ffd166; font-style: italic; }
    .diagram .pt { fill:#60a5fa; }
    .diagram .P { fill:#facc15; }
    .diagram line { stroke:#9fb3c8; stroke-width:1.1; }
    .diagram circle.big { stroke:#9fb3c8; fill:none; stroke-width:.8; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>後方交会・自由設置 計算アプリ</h1>
      <span class="pill">JP軸 / DMS / AutoRef</span>
    </div>
  </header>
  <main class="two-col">
    <section class="card grid">
      <div>
        <h2 style="margin:0 0 .5rem 0;">① モード選択</h2>
        <div class="row">
          <label><input type="radio" name="mode" value="tienstra" checked> 3点（角のみ：Tienstra）</label>
          <label><input type="radio" name="mode" value="twodist"> 2点（距離あり：円交点）</label>
        </div>
        <p class="muted">UIは <strong>X（北）/ Y（東）</strong>。角はDMS。A→B→Cの順に座標、角は γ=∠APB, α=∠BPC, β=∠CPA の順。</p>
      </div>

      <div id="inputs"></div>

      <div class="btnbar">
        <button class="btn" id="calcBtn">計算する</button>
        <button class="btn ghost" id="resetBtn">リセット</button>
      </div>

      <div id="result" class="grid"></div>

      <div id="diagramWrap" class="hr" style="display:none"></div>
      <div id="diagram" class="diagram" style="display:none" aria-label="略図（時計回りに A→B→C）">
        <svg viewBox="0 0 260 200">
          <circle cx="130" cy="95" r="60" class="big" />
          <line x1="130" y1="95" x2="195" y2="40" />
          <line x1="130" y1="95" x2="205" y2="170" />
          <line x1="130" y1="95" x2="35" y2="95" />
          <circle cx="195" cy="40" r="4" class="pt"/><text x="206" y="42">A</text>
          <circle cx="205" cy="170" r="4" class="pt"/><text x="214" y="175">B</text>
          <circle cx="35"  cy="95"  r="4" class="pt"/><text x="22"  y="100">C</text>
          <circle cx="130" cy="95" r="4" class="P"/><text x="137" y="90">P</text>
          <text x="188" y="95" class="arcLbl">γ</text>
          <text x="130" y="150" class="arcLbl">α</text>
          <text x="105" y="65"  class="arcLbl">β</text>
        </svg>
      </div>
    </section>

    <aside class="card grid">
      <h2 style="margin:0;">② 杭打ち（Stakeout）</h2>
      <p class="muted">器械点の座標が出たら、設置したい点Tまでの<strong>水平距離</strong>と<strong>角度</strong>（方位角/右回り角）を計算。</p>
      <div class="row">
        <div>
          <label>器械点 X（北）</label>
          <input id="IX" type="number" step="0.0001">
        </div>
        <div>
          <label>器械点 Y（東）</label>
          <input id="IY" type="number" step="0.0001">
        </div>
      </div>
      <div class="row">
        <div>
          <label>ターゲットT X（北）</label>
          <input id="TX" type="number" step="0.0001">
        </div>
        <div>
          <label>ターゲットT Y（東）</label>
          <input id="TY" type="number" step="0.0001">
        </div>
      </div>
      <div class="row">
        <div>
          <label>基準視準（任意）</label>
          <select id="refSel">
            <option value="">基準なし（絶対方位角）</option>
            <option value="A">A（自動入力）</option>
            <option value="B">B（自動入力）</option>
            <option value="C">C（自動入力）</option>
          </select>
          <div class="muted" style="margin-top:.3rem;">選ぶと右欄に自動入力（編集可）</div>
        </div>
        <div>
          <label>基準点の座標 X,Y</label>
          <input id="refXY" type="text" placeholder="例: 18678.919, 17565.820">
        </div>
      </div>
      <div class="btnbar">
        <button class="btn secondary" id="stakeBtn">杭打ち計算</button>
      </div>
      <div id="stakeout"></div>
    </aside>
  </main>

  <footer>
    <div>© <span id="year"></span> Resection PWA JP. v1.6</div>
  </footer>

  <script>
    const $ = s => document.querySelector(s);
    const byId = id => document.getElementById(id);

    // DMS helpers
    function dmsToDec(d,m,s){ const sign=Math.sign(d)||1; const ad=Math.abs(d); return sign*(ad+(m||0)/60+(s||0)/3600); }
    function decToDms(dec){ const norm360=d=>((d%360)+360)%360; let x=norm360(dec); const d=Math.floor(x); const mFloat=(x-d)*60; const m=Math.floor(mFloat); const s=(mFloat-m)*60; return {d,m,s}; }
    function fmtDMS(dec,frac=2){ const {d,m,s}=decToDms(dec); return `${d}° ${m}′ ${s.toFixed(frac)}″`; }

    // math helpers
    const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI,norm360=d=>((d%360)+360)%360,diffCW=(f,t)=>norm360(t-f);
    const bearingEN=(E1,N1,E2,N2)=>{ const dE=E2-E1,dN=N2-N1; return norm360(toDeg(Math.atan2(dE,dN))); };
    function angleAt(Ea,Na,Eb,Nb,Ec,Nc){ let ang=diffCW(bearingEN(Ea,Na,Eb,Nb),bearingEN(Ea,Na,Ec,Nc)); if(ang>180) ang=360-ang; return ang; }

    function valNum(id,name){ const v=parseFloat(byId(id).value); if(!Number.isFinite(v)) throw `${name} を入力してください`; return v; }
    function dmsInput(prefix,name){ const d=parseFloat(byId(prefix+'D').value||'0'); const m=parseFloat(byId(prefix+'M').value||'0'); const s=parseFloat(byId(prefix+'S').value||'0'); const dec=dmsToDec(d,m,s); if(!Number.isFinite(dec)) throw `${name} を入力してください`; return dec; }

    // UI builder
    function renderInputs(){
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const el = byId('inputs');
      const showDiag = (mode === 'tienstra');
      byId('diagramWrap').style.display = showDiag ? 'block' : 'none';
      byId('diagram').style.display = showDiag ? 'flex' : 'none';

      
if (mode === 'tienstra'){
  el.innerHTML = `
    <div class="row">
      <div><label>A X（北）</label><input id="AX" type="number" step="0.0001" inputmode="decimal"></div>
      <div><label>A Y（東）</label><input id="AY" type="number" step="0.0001" inputmode="decimal"></div>
    </div>
    <div class="angleBlock">
      <div class="angleTitle">γ = ∠APB（度・分・秒）</div>
      <div class="angleRow">
        <input id="gammaD" type="number" step="1" inputmode="decimal" placeholder="度"><div class="unit">°</div>
        <input id="gammaM" type="number" step="1" inputmode="decimal" placeholder="分"><div class="unit">′</div>
        <input id="gammaS" type="number" step="0.01" inputmode="decimal" placeholder="秒"><div class="unit">″</div>
      </div>
    </div>

    <div class="row" style="margin-top:.4rem;">
      <div><label>B X（北）</label><input id="BX" type="number" step="0.0001" inputmode="decimal"></div>
      <div><label>B Y（東）</label><input id="BY" type="number" step="0.0001" inputmode="decimal"></div>
    </div>
    <div class="angleBlock">
      <div class="angleTitle">α = ∠BPC（度・分・秒）</div>
      <div class="angleRow">
        <input id="alphaD" type="number" step="1" inputmode="decimal" placeholder="度"><div class="unit">°</div>
        <input id="alphaM" type="number" step="1" inputmode="decimal" placeholder="分"><div class="unit">′</div>
        <input id="alphaS" type="number" step="0.01" inputmode="decimal" placeholder="秒"><div class="unit">″</div>
      </div>
    </div>

    <div class="row" style="margin-top:.4rem;">
      <div><label>C X（北）</label><input id="CX" type="number" step="0.0001" inputmode="decimal"></div>
      <div><label>C Y（東）</label><input id="CY" type="number" step="0.0001" inputmode="decimal"></div>
    </div>
    <div class="angleBlock">
      <div class="angleTitle">β = ∠CPA（度・分・秒）</div>
      <div class="angleRow">
        <input id="betaD" type="number" step="1" inputmode="decimal" placeholder="度"><div class="unit">°</div>
        <input id="betaM" type="number" step="1" inputmode="decimal" placeholder="分"><div class="unit">′</div>
        <input id="betaS" type="number" step="0.01" inputmode="decimal" placeholder="秒"><div class="unit">″</div>
      </div>
    </div>
  `;
} else {
        // 2点: 横並び (AX|AY|PA), (BX|BY|PB), ∠APBは下
        el.innerHTML = `
          <div class="row3">
            <div><label>A X（北）</label><input id="AX" type="number" step="0.0001"></div>
            <div><label>A Y（東）</label><input id="AY" type="number" step="0.0001"></div>
            <div><label>PA 距離 [m]</label><input id="PA" type="number" step="0.0001"></div>
          </div>
          <div class="row3">
            <div><label>B X（北）</label><input id="BX" type="number" step="0.0001"></div>
            <div><label>B Y（東）</label><input id="BY" type="number" step="0.0001"></div>
            <div><label>PB 距離 [m]</label><input id="PB" type="number" step="0.0001"></div>
          </div>
          <div class="angleBlock">
            <div class="angleTitle">∠APB（任意・解選択）</div>
            <div class="angleRow">
              <input id="phiD" type="number" step="1" placeholder="度"><div class="unit">°</div>
              <input id="phiM" type="number" step="1" placeholder="分"><div class="unit">′</div>
              <input id="phiS" type="number" step="0.01" placeholder="秒"><div class="unit">″</div>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn ghost" type="button" id="flipBtn">別解候補</button>
          </div>`;
        const flip = byId('flipBtn');
        flip?.addEventListener('click', ()=>{
          window.__useAlt = !window.__useAlt;
          byId('result').innerHTML = `<div class="muted">別解候補を選択中。もう一度「計算する」を押してください。</div>`;
        });
      }
    }

    // core
    function tienstra(AE,AN,BE,BN,CE,CN,alpha,beta,gamma){
      const A=angleAt(AE,AN,BE,BN,CE,CN), B=angleAt(BE,BN,CE,CN,AE,AN), C=angleAt(CE,CN,AE,AN,BE,BN);
      const K1=1/(1/Math.tan(toRad(A))-1/Math.tan(toRad(alpha)));
      const K2=1/(1/Math.tan(toRad(B))-1/Math.tan(toRad(beta)));
      const K3=1/(1/Math.tan(toRad(C))-1/Math.tan(toRad(gamma)));
      const denom=K1+K2+K3;
      if(!Number.isFinite(denom)||Math.abs(denom)<1e-12) throw "数値が不安定（危険円付近・角度の組合せ不良）のため計算できません。";
      return {E:(K1*AE+K2*BE+K3*CE)/denom, N:(K1*AN+K2*BN+K3*CN)/denom, A,B,C};
    }
    function twoCircle(AE,AN,BE,BN,r1,r2){
      const dx=BE-AE, dy=BN-AN, d=Math.hypot(dx,dy);
      if(d<1e-12) throw "AとBが同一点です。";
      if(d>r1+r2+1e-12) throw "2円が離れていて交点がありません。";
      if(d<Math.abs(r1-r2)-1e-12) throw "一方の円が他方を内包して交わりません。";
      const a=(r1*r1-r2*r2+d*d)/(2*d), h2=r1*r1-a*a, h=h2<0?0:Math.sqrt(h2);
      const x0=AE+a*dx/d, y0=AN+a*dy/d, rx=-dy*(h/d), ry=dx*(h/d);
      return [{E:x0+rx,N:y0+ry},{E:x0-rx,N:y0-ry}];
    }
    function pickByAngle(Ps,AE,AN,BE,BN,phi){
      if(!Number.isFinite(phi)||Ps.length<2) return Ps[0];
      function incl(P){ let a1=bearingEN(P.E,P.N,AE,AN); let a2=bearingEN(P.E,P.N,BE,BN); let ang=diffCW(a1,a2); if(ang>180) ang=360-ang; return ang; }
      const d0=Math.abs(incl(Ps[0])-phi), d1=Math.abs(incl(Ps[1])-phi);
      return d0<=d1?Ps[0]:Ps[1];
    }

    // actions
    function onCalc(){
      const mode = document.querySelector('input[name="mode"]:checked').value;
      try{
        let out="";
        if(mode==='tienstra'){
          const AX=valNum('AX','A X'), AY=valNum('AY','A Y');
          const BX=valNum('BX','B X'), BY=valNum('BY','B Y');
          const CX=valNum('CX','C X'), CY=valNum('CY','C Y');
          const gamma=dmsInput('gamma','γ'), alpha=dmsInput('alpha','α'), beta=dmsInput('beta','β');
          const AE=AY, AN=AX, BE=BY, BN=BX, CE=CY, CN=CX;
          const {E,N,A,B,C}=tienstra(AE,AN,BE,BN,CE,CN,alpha,beta,gamma);
          const PX=N, PY=E;
          byId('IX').value=PX.toFixed(4); byId('IY').value=PY.toFixed(4);
          out += `<h3 style="margin:.2rem 0;">器械点（P）</h3>`;
          out += `<table><tr><th>項目</th><th>値</th></tr>
            <tr><td>X（北）</td><td class="mono">${PX.toFixed(4)}</td></tr>
            <tr><td>Y（東）</td><td class="mono">${PY.toFixed(4)}</td></tr>
          </table>`;
          out += `<div class="hr"></div>`;
          out += `<table><tr><td>△ABC 内角</td><td class="mono">A=${fmtDMS(A)}, B=${fmtDMS(B)}, C=${fmtDMS(C)}</td></tr>
                  <tr><td>α+β+γ</td><td class="mono">${fmtDMS(alpha+beta+gamma)}</td></tr></table>`;
        } else {
          const AX=valNum('AX','A X'), AY=valNum('AY','A Y');
          const BX=valNum('BX','B X'), BY=valNum('BY','B Y');
          const r1=valNum('PA','PA距離'), r2=valNum('PB','PB距離');
          let phi=NaN; const hasPhi = byId('phiD').value || byId('phiM').value || byId('phiS').value;
          if(hasPhi){ phi=dmsInput('phi','∠APB'); }
          const AE=AY, AN=AX, BE=BY, BN=BX;
          const cand=twoCircle(AE,AN,BE,BN,r1,r2);
          let P = pickByAngle(cand,AE,AN,BE,BN,phi);
          if(window.__useAlt && cand.length>1){ P = (P.E===cand[0].E && P.N===cand[0].N)? cand[1] : cand[0]; }
          const PX=P.N, PY=P.E;
          byId('IX').value=PX.toFixed(4); byId('IY').value=PY.toFixed(4);
          let inc=(()=>{ let a1=bearingEN(P.E,P.N,AE,AN); let a2=bearingEN(P.E,P.N,BE,BN); let ang=diffCW(a1,a2); if(ang>180) ang=360-ang; return ang; })();
          out += `<h3 style="margin:.2rem 0;">器械点（P）</h3>`;
          out += `<table><tr><th>項目</th><th>値</th></tr>
            <tr><td>X（北）</td><td class="mono">${PX.toFixed(4)}</td></tr>
            <tr><td>Y（東）</td><td class="mono">${PY.toFixed(4)}</td></tr>
            <tr><td>∠APB（算出）</td><td class="mono">${fmtDMS(inc)}</td></tr>
          </table>`;
          if(!Number.isNaN(phi)){ const diff=Math.abs(inc-phi); out += `<p class="muted">観測 ∠APB=${fmtDMS(phi)} と比較：差 ${fmtDMS(diff,2)}</p>`; }
        }
        byId('result').innerHTML=out;
      }catch(e){
        byId('result').innerHTML = `<p style="color:#ff5c5c;">エラー：${e}</p>`;
      }
    }

    function onStake(){
      try{
        const IX=valNum('IX','器械点X'), IY=valNum('IY','器械点Y');
        const TX=valNum('TX','ターゲットX'), TY=valNum('TY','ターゲットY');
        const IE=IY, IN=IX, TE=TY, TN=TX;
        const D=Math.hypot(TE-IE, TN-IN), azIT=bearingEN(IE,IN,TE,TN);
        let angleRightInfo="";
        const ref=byId('refSel').value;
        if(ref){
          const txt=byId('refXY').value.trim();
          const [rx,ry]=txt.split(/[ ,]+/).map(Number);
          if(!Number.isFinite(rx)||!Number.isFinite(ry)) throw "基準点座標を 'X,Y' 形式で入力してください。";
          const RE=ry, RN=rx, azIR=bearingEN(IE,IN,RE,RN), right=diffCW(azIR,azIT);
          angleRightInfo = `<tr><td>右回り角（基準→T）</td><td class="mono">${fmtDMS(right)}</td></tr>
                            <tr><td>基準方位角（器械→基準）</td><td class="mono">${fmtDMS(azIR)}</td></tr>`;
        }
        byId('stakeout').innerHTML = `<table>
            <tr><th>項目</th><th>値</th></tr>
            <tr><td>水平距離（P→T）</td><td class="mono">${D.toFixed(4)} m</td></tr>
            <tr><td>方位角（P→T）</td><td class="mono">${fmtDMS(azIT)}</td></tr>
            ${angleRightInfo}
          </table>`;
      }catch(e){
        byId('stakeout').innerHTML = `<p style="color:#ff5c5c;">エラー：${e}</p>`;
      }
    }

    function onRefChanged(){
      const sel=byId('refSel').value;
      const ax=byId('AX')?.value, ay=byId('AY')?.value;
      const bx=byId('BX')?.value, byy=byId('BY')?.value;
      const cx=byId('CX')?.value, cy=byId('CY')?.value;
      let x=null,y=null;
      if(sel==='A'&&ax&&ay){ x=ax; y=ay; }
      if(sel==='B'&&bx&&byy){ x=bx; y=byy; }
      if(sel==='C'&&cx&&cy){ x=cx; y=cy; }
      if(x!==null && y!==null){ byId('refXY').value = `${x}, ${y}`; }
    }

    document.addEventListener('change', (e)=>{
      if (e.target.name === 'mode') renderInputs();
      if (e.target.id === 'refSel') onRefChanged();
    });
    document.addEventListener('DOMContentLoaded', ()=>{
      renderInputs();
      byId('year').textContent = new Date().getFullYear();
      byId('calcBtn').addEventListener('click', onCalc);
      byId('resetBtn').addEventListener('click', ()=> location.reload());
      byId('stakeBtn').addEventListener('click', onStake);
      byId('refSel').addEventListener('change', onRefChanged);
    });

    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }
  </script>
</body>
</html>
